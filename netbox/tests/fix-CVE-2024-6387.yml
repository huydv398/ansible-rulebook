---
- name: Check if OpenSSH is vulnerable to 'RegreSSHion'
  hosts: all
  gather_facts: true
  vars:
   patched_versions:
    - SSH-2.0-OpenSSH_8.9p1 Ubuntu-3ubuntu0.10
    - SSH-2.0-OpenSSH_9.3p1 Ubuntu-3ubuntu3.6
  ###############################################
  tasks:
    ###############################################
    - name: Gather package facts
      ansible.builtin.package_facts:
    ###############################################
    # - name: Filter for packages including 'openssh' and extract version
    #   ansible.builtin.set_fact:
    #     openssh_versions: >-
    #       {{
    #         ansible_facts.packages
    #         | dict2items
    #         | selectattr('key', 'search', 'openssh')
    #         | map(attribute='value')
    #         | selectattr(0, 'defined')
    #         | map('first')
    #         | map(attribute='version')
    #         | list
    #       }}
    # ###############################################
    # - name: Display message if vulnerable
    #   ansible.builtin.debug:
    #     msg: "OpenSSH version is '{{ openssh_versions[0] }}' which is vulnerable to 'RegreSSHion' !!!"
    #   # when: >-
    #   #   openssh_versions | length > 0
    #   #   and
    #   #   ((openssh_versions[0] is version('4.4p1', '<'))
    #   #   or
    #   #   (openssh_versions[0] is version('8.5p1', '>=') and openssh_versions[0] is version('9.7p1', '<=')))
    #   when: >-
    #     openssh_versions | length > 0
    #     and
    #     openssh_versions[0] is not search('8.9p1-3ubuntu0.10')

    # - name: Display message if vulnerable
    #   ansible.builtin.debug:
    #     msg: '{{ openssh_versions[0] }}'
    #   # when: openssh_versions[0] is search('ubuntu')
    #   when: openssh_versions | length > 0
    # # - name: Get facts
    #   debug:
    #     msg: "{{ ansible_facts}}"
  
    - name: Filter for packages including 'openssh' and extract version
      ansible.builtin.set_fact:
        openssh_versions: >-
          {{
            ansible_facts.packages
            | dict2items
            | selectattr('key', 'search', 'openssh')
            | map(attribute='value')
            | selectattr(0, 'defined')
            | map('first')
            | map(attribute='version')
            | list
          }}
    
    - name: Display message if vulnerable
      ansible.builtin.debug:
        msg: "{{ openssh_versions[0] }}"
