---
- name: Gather cluster information for vCenter
  gather_facts: no
  vars_files:
    - /root/ansible-rolebook/netbox/inventory/group_vars/all/02.vcenter.yml
  hosts: localhost
  tasks:
    - name: Create a New Virtual Machine
      vmware_guest:
        #thông tin vcenter được lấy từ file ~/vmware/inventory/group_vars/all/04-vcenter_server.yml
        hostname: vcenter.addc.local
        username: "{{ vcenter_user }}"
        password: "{{ vcenter_pass }}"
        validate_certs: "{{ ova_validate_certs }}"
        datacenter: "{{ datacenter }}"
        cluster: "{{ cluster_name }}"
        folder: "{{ tenant }}"
        template: 'template-centos7' #Tên Template muốn clone
        datastore: data # Tên Datastore chứa TMP
        name: Duonghuy # lấy tên từ file host ~//vmware/inventory/hosts
      # Các biến bên dưới được gọi ra từ ~/vmware/inventory/host_vars/vm-host
        guest_id: 'centos7_64Guest'
        disk:
        - size_gb: 20
          type: thin
          datastore: DATA02
        hardware: 
          memory_mb: 2048
          num_cpus: 2
          scsi: paravirtual
        # networks: 
        # - name: "{{ vm_network_label }}"
        #   device_type: "{{ vm_network_type }}"
        #   ip: "{{ vm_network_ip }}" 
        #   netmask: "{{ vm_network_netmask }}"
        #   gateway: "{{ vm_network_gateway }}"
        #   domain: "{{ vm_network_domain }}"
        #   dns_servers: "{{ vm_network_dns }}"
        # customization:
        #   hostname: "{{ inventory_hostname_short }}" #hostname sẽ đặt cho VM
        #   password: "{{ password_VM }}"
        # wait_for_customization: yes # tự động bật máy ảo khi hoàn thành
        # wait_for_ip_address: True #Đợi khi VM nhận IP máy ảo. sẽ đợi vCenter dò tìm địa chỉ IP trên máy ảo trước khi hoàn tất.
        state: poweredon #Thực hiện bật máy ảo sau khi tạo
      delegate_to: localhost